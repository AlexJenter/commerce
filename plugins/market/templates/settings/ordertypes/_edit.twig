{% extends "market/_layouts/cp" %}

{% set crumbs = [
{ label: "Market Settings"|t, url: url('market/settings') },
{ label: "Order Types"|t, url: url('market/settings/ordertypes') },
] %}


{% set selectedTab = 'settings' %}
{% import "_includes/forms" as forms %}

{% set content %}
<form method="post" accept-charset="UTF-8" data-saveshortcut>
    <input type="hidden" name="action" value="market/orderType/saveOrderType">
    <input type="hidden" name="redirect" value="market/settings/ordertypes">

    {{ getCsrfInput() }}
    {% if orderType.id %}<input type="hidden" name="orderTypeId" value="{{ orderType.id }}">{% endif %}

    {% set tabs = {
        0: {'label':'Name & Info','url':'#tab0'},
        1: {'label':'Statuses','url':'#tab1'},
        2: {'label':'Fields','url':'#tab2'}
        }
    %}

    <div id="tab0">

    {{ forms.textField({
        first: true,
        label: "Name"|t,
        instructions: "What this order type will be called in the CP."|t,
        id: 'name',
        name: 'name',
        value: orderType.name,
        errors: orderType.getErrors('name'),
        autofocus: true,
        required: true,
        translatable: true
    }) }}

    {{ forms.textField({
        label: "Handle"|t,
        instructions: "How you’ll refer to this order type in code or templates."|t,
        id: 'handle',
        class: 'code',
        name: 'handle',
        value: orderType.handle,
        errors: orderType.getErrors('handle'),
        required: true
    }) }}

    </div>

    <div id="tab1" class="hidden">

    {% set orderStatuses %}
        <table id="orderStatuses" class="data fullwidth collapsible">
            <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Handle</th>
                <th scope="col">Color</th>
                <th scope="col">Emails</th>
                <th scope="col">Is Default?</th>
                <td class="thin"></td>
            </tr>
            </thead>
            <tbody>
            {% for orderStatus in orderType.orderStatuses %}
                <tr data-id="{{ orderStatus.id }}" data-name="{{ orderStatus.handle }}">
                    <th scope="row" data-title="Name"><a href="{{ orderStatus.getCpEditUrl() }}">{{ orderStatus.name }}</a></th>
                    <td data-title="Handle">{{ orderStatus.handle }}</td>
                    <td data-title="Color"><span style="color: {{ orderStatus.color }}">&block;</span> {{ orderStatus.color }}</td>
                    <td data-title="Emails">
                        {% for email in orderStatus.emails %}
                            {{ email.name }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                    <td>{{ orderStatus.default ? 'Yes' : 'No' }}</td>
                    <td class="thin"><a class="delete icon" title="{{ 'Delete'|t }}" role="button"></a></td>
                </tr>
            {% endfor %}

            </tbody>
        </table>

        <div class="btngroup submit first">
            {% if orderType.id %}
                <a href="{{ url('market/settings/ordertypes/' ~ orderType.id ~ '/orderstatuses/new') }}" class="btn submit">New Order Status</a>
            {% else %}
                <a href="#" class="btn submit disabled" title="Save the order type before creating belonging statuses">New Order Status</a>
            {% endif %}
        </div>
    {% endset %}

    {{ forms.field({
        instructions: 'Order statuses available for the orders of this type.'|t,
        label:    'Order Statuses'|t
    }, orderStatuses) }}

    </div>

    <div id="tab2" class="hidden">

    {% include "_includes/fieldlayoutdesigner" with {
    fieldLayout: orderType.getFieldLayout(),
    } only %}


    </div>

    <hr>

    <div class="buttons">
        <input type="submit" class="btn submit" value="{{ 'Save'|t }}">
    </div>
</form>

{% endset %}

{% set js %}
{% if not orderType.handle %}new Craft.HandleGenerator('#name', '#handle');{% endif %}
{#<script>#}
$(function () {
    $('#shippingMethodId').selectize({
        plugins: ['remove_button'],
        dropdownParent: 'body'
    });

    new Craft.AdminTable({
        tableSelector: '#orderStatuses',
        deleteAction: 'market/orderStatus/delete',
        confirmDeleteMessage: '{{ "Are you sure you want to delete “{name}”?"|t }}'
    });
});
{% endset %}
{% includeJs js %}
