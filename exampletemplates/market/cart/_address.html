{% import 'market/cart/_addressMacro.html' as forms %}
{% include 'market/cart/_addressMacro.html' %}

<h2>Fill the Address form</h2>

{% if not craft.session.isLoggedIn() %}
<strong>Notice: You are working as guest. It is recommended to sign up to associate the order with your credentials</strong><br/>
{% endif %}

{% set addresses = craft.market.customer.addresses %}
{% set order = craft.market.cart %}


{% if addresses %}
    {# UI when at least one address exists #}
    <form method="post" style="float: left; border: 1px solid #bbbbbb">
        <input type="hidden" name="action" value="market/cartAddress/chooseAddresses">

        <h3>Choose an address for Shipping</h3>

        {% for address in addresses %}
            <label class="address-chooser" style=" display: block; float: left; margin: 10px; padding: 10px; border: 1px solid #bbbbbb">
                {% for key,value in address.attributes %}
                    {{ key|makeLabel }}: <span class="address-option" data-key="{{ key }}" data-value="{{ value }}">{{ value }}</span><br/>
                {% endfor %}

                <a class="address-remove" data-id="{{ address.id }}" href="#">Remove</a><br/>
                <a class="address-update" data-id="{{ address.id }}" href="#">Update</a><br/>

                <input type="radio" name="billingAddressId" value="{{ address.id }}" {% if order.billingAddressId == address.id %}checked{% endif %} />
                <strong>Choose this</strong>
            </label>
        {% endfor %}

        <div style="clear: both;"></div>
        <h3>Choose an address for Billing</h3>

        {% for address in addresses %}
            <label class="address-chooser" style=" display: block; float: left; margin: 10px; padding: 10px; border: 1px solid #bbbbbb">
                {% for key,value in address.attributes %}
                    {{ key|makeLabel }}: <span class="address-option" data-key="{{ key }}" data-value="{{ value }}">{{ value }}</span><br/>
                {% endfor %}

                <a class="address-remove" data-id="{{ address.id }}" href="#">Remove</a><br/>
                <a class="address-update" data-id="{{ address.id }}" href="#">Update</a><br/>

                <input type="radio" name="billingAddressId" value="{{ address.id }}" {% if order.billingAddressId == address.id %}checked{% endif %} />
                <strong>Choose this</strong>
            </label>
        {% endfor %}

        <div style="clear: both;"></div>
        <input type="submit" value="Confirm addresses">
    </form>

    <form method="post" class="form-new-address" style="float: left; margin-left: 50px;; border: 1px solid #bbbbbb">
        <h3 class="form-new-address__label">Add New Address</h3>
        <input type="hidden" name="action" value="market/cartAddress/addAddress">
        <input type="hidden" name="Address[id]" value="">

        {{ forms.addressForm('Address', newAddress is defined ? newAddress : null ) }}

        <input type="submit" value="Add New Address">
    </form>

{% else %}
    {# UI when no addresses exist #}
    <form method="post">
        <input type="hidden" name="action" value="market/cartAddress/postTwoAddresses">

        <h3>Shipping Address</h3>
        {{ forms.addressForm('ShippingAddress', shippingAddress is defined ? shippingAddress : null ) }}

        <h3>Billing Address</h3>
        {{ forms.addressForm('BillingAddress', billingAddress is defined ? billingAddress : null) }}

        <input type="submit" value="Confirm addresses">
    </form>
{% endif %}

{% set js %}

$('.address-remove').click(function(e) {
    e.preventDefault();
    $.post(window.location, {
        action: 'market/cartAddress/removeAddress',
        id: $(this).data('id')
    }, function() {
        window.location = window.location.href;
    });
});

$('.address-update').click(function(e) {
    e.preventDefault();
    var $newForm = $('.form-new-address');

    $('.form-new-address__label').text('Update Address #' + $(this).data('id'));

    $(this).parents('.address-chooser').find('.address-option').each(function() {
        var key = $(this).data('key'),
            value = $(this).data('value'),
            $input = $newForm.find('[name="Address[' + key + ']"]');

        $input.val(value);

        if(key == 'countryId') {
            $input.change();
        }
    });
});
{% endset %}
{% includeJs js %}