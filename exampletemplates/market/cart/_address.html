{% import 'market/cart/_addressMacro.html' as forms %}
{% include 'market/cart/_addressMacro.html' %}


{% if not craft.session.isLoggedIn() %}
<strong>Notice: You are working as guest. It is recommended to sign up to associate the order with your credentials</strong><br/>
{% endif %}

{% set addresses = craft.market.customer.addresses %}
{% set order = craft.market.getCart('cart') %}


{% if addresses %}
    {# UI when at least one address exists #}
    <form method="post" class="form-horizontal">
        <input type="hidden" name="action" value="market/cartAddress/chooseAddresses">
        <input type="hidden" name="redirect" value="market/cart">
        <input type="hidden" name="orderTypeHandle" value="cart">
        {{ getCsrfInput() }}
        <h3>Choose an address for Shipping</h3>

        {% if order.hasErrors('shippingAddressId') %}<strong style="color: #ff2000">Error: {{ order.getErrors('shippingAddressId')|join }}</strong><br/>{% endif %}

        {% for address in addresses %}
            <label class="address-chooser" style=" display: block; float: left; margin: 10px; padding: 10px; border: 1px solid #bbbbbb">
                {% for key,value in address.attributes %}
                    {{ key|marketTitleize }}: <span class="address-option" data-key="{{ key }}" data-value="{{ value }}">{{ value }}</span><br/>
                {% endfor %}

                <a class="address-remove" data-id="{{ address.id }}" href="#">Remove</a><br/>
                <a class="address-update" data-id="{{ address.id }}" href="#">Update</a><br/>

                <input type="radio" name="shippingAddressId" value="{{ address.id }}" {% if order.shippingAddressId == address.id %}checked{% endif %} />
                <strong>Choose this</strong>
            </label>
        {% endfor %}

        <div style="clear: both;"></div>
        <h3>Choose an address for Billing</h3>

        {% if order.hasErrors('billingAddressId') %}<strong style="color: #ff2000">Error: {{ order.getErrors('billingAddressId')|join }}</strong><br/>{% endif %}

        {% for address in addresses %}
            <label class="address-chooser" style=" display: block; float: left; margin: 10px; padding: 10px; border: 1px solid #bbbbbb">
                {% for key,value in address.attributes %}
                    {{ key|marketTitleize }}: <span class="address-option" data-key="{{ key }}" data-value="{{ value }}">{{ value }}</span><br/>
                {% endfor %}

                <a class="address-remove" data-id="{{ address.id }}" href="#">Remove</a><br/>
                <a class="address-update" data-id="{{ address.id }}" href="#">Update</a><br/>

                <input type="radio" name="billingAddressId" value="{{ address.id }}" {% if order.billingAddressId == address.id %}checked{% endif %} />
                <strong>Choose this</strong>
            </label>
        {% endfor %}

        <div style="clear: both;"></div>
        <input type="submit" value="Confirm addresses">
    </form>

    <form method="post" class="form-new-address" class="form-horizontal">
        <h3 class="form-new-address__label">Add New Address</h3>
        <input type="hidden" name="action" value="market/cartAddress/addAddress">
        <input type="hidden" name="orderTypeHandle" value="cart">
        <input type="hidden" name="Address[id]" value="">
        {{ getCsrfInput() }}

        {{ forms.addressForm('Address', newAddress is defined ? newAddress : null ) }}

        <input type="submit" value="Add New Address">
    </form>

{% else %}
    {# UI when no addresses exist #}
    <div class="row">
    <form method="post" class="">
        <input type="hidden" name="action" value="market/cartAddress/postTwoAddresses">
        <input type="hidden" name="orderTypeHandle" value="cart">
        {{ getCsrfInput() }}
        <div class="col-md-6">

        {{ forms.addressForm('BillingAddress', billingAddress is defined ? billingAddress : null) }}
        <div class="checkbox">
            <label>
                <input type="hidden" name="sameAddress" value="0">
                <input id="sameAddress" name="sameAddress" type="checkbox" value="1" checked> Shipping Address same as Billing Address
            </label>
        </div>
        <input type="submit" class="btn btn-primary" value="Confirm addresses">
        </div>
        <div class="col-md-6">
            {{ forms.addressForm('ShippingAddress', shippingAddress is defined ? shippingAddress : null ) }}
        </div>

    </form>
    </div>
{% endif %}

{% set js %}

$('.address-remove').click(function(e) {
    e.preventDefault();
    $.post(window.location, {
        action: 'market/cartAddress/removeAddress',
        id: $(this).data('id')
    }, function() {
        window.location = window.location.href;
    });
});

$('.address-update').click(function(e) {
    e.preventDefault();
    var $newForm = $('.form-new-address');

    $('.form-new-address__label').text('Update Address #' + $(this).data('id'));

    $(this).parents('.address-chooser').find('.address-option').each(function() {
        var key = $(this).data('key'),
            value = $(this).data('value'),
            $input = $newForm.find('[name="Address[' + key + ']"]');

        $input.val(value);

        if(key == 'countryId') {
            $input.change();
        }
    });
});
$('.addressBox.ShippingAddress').hide();
$("#sameAddress").change(function(e) {
    $('.addressBox.ShippingAddress').toggle();
});

{% endset %}
{% includeJs js %}