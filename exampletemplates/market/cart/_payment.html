<form method="POST">
    <input type="hidden" name="action" value="market/cart/goToCart" />
    <input type="hidden" name="redirect" value="market/cart" />
    <input class="btn btn-primary" type="submit" value="Edit Cart" />
</form>

<h3>Payment</h3>

{% if cart.shippingMethodId %}
    <p>
        <strong>Chosen shipping method:</strong> {{ cart.shippingMethod.name }}
    </p>
{% endif %}
<form method="POST" class="form-inline">
    <input type="hidden" name="action" value="market/cartAddress/setShippingMethod">
    <input type="hidden" name="redirect" value="market/cart">
    <input type="hidden" name="orderTypeHandle" value="cart">
    Shipping Method:
    <select name="shippingMethodId" class="form-control" >
        {% for id,method in craft.market.getShippingMethods('cart') %}
            <option value="{{ id }}" {% if id == cart.shippingMethodId %}selected{% endif %}>{{ method.name }}: {{ method.amount }}</option>
        {% endfor %}
    </select>
    <input type="submit" class="btn" value="Set" />
    {% if shippingMethodError is defined %}<strong>Error: {{ shippingMethodError }}</strong>{% endif %}
</form>

{# Assuming that the shipping method is set, the person has entered everthing
   for them to know the final price they are willing to pay. Allow them to choose
   the payment method they would like to use. #}
{% if cart.shippingMethodId %}
    {% include "market/cart/_setPaymentMethod" %}
{% endif %}

{% if cart.paymentMethodId %}
<form method="POST" class="form-horizontal">
    <input type="hidden" name="action" value="market/cartPayment/pay"/>
    <input type="hidden" name="returnUrl" value="/market/orders"/>
    <input type="hidden" name="cancelUrl" value="/market/cart"/>
    <input type="hidden" name="orderTypeHandle" value="cart">
    {{ getCsrfInput() }}

    <div class="row row-centered">
        <div class="col-md-4 col-md-offset-4">
            <div class="page-header">
                <h2 class="">Secure Payment Form</h2>
            </div>
            <noscript>
                <div class="bs-callout bs-callout-danger">
                    <h4>JavaScript is not enabled!</h4>
                    <p>This payment form requires your browser to have JavaScript enabled. Please activate JavaScript and reload this page. Check <a href="http://enable-javascript.com" target="_blank">enable-javascript.com</a> for more informations.</p>
                </div>
            </noscript>
            {% if customError is defined and customError %}
                <div class="alert alert-danger">
                    <strong>Error!</strong> {{ customError }}
                </div>
            {% endif %}

            <span class="payment-success"></span>
        </div>
    </div>
    <fieldset>
        {% if cart.paymentMethod.requiresCard() %}
        {% set currentYear = date().format('Y') %}
        {% set formValues = {
            firstName: paymentForm is defined ? paymentForm.firstName : cart.billingAddress.firstName,
            lastName: paymentForm is defined ? paymentForm.lastName : cart.billingAddress.lastName,
            number: paymentForm is defined ? paymentForm.number : '',
            cvv: paymentForm is defined ? paymentForm.cvv : '',
            month: paymentForm is defined ? paymentForm.month : 1,
            year: paymentForm is defined ? paymentForm.year : currentYear,
        } %}

        <!-- Card Holder Name -->
        <div class="form-group {% if paymentForm is defined and (paymentForm.hasErrors('firstName') or paymentForm.hasErrors('firstName')) %}has-error{% endif %}">
            <label class="col-sm-2 control-label">Card Holder's Name</label>
            <div class="col-sm-3">
                <input name="firstName" maxlength="70" placeholder="Card Holder First Name" class="card-holder-first-name form-control"
                       value="{{ formValues.firstName }}">
            </div>
            <div class="col-sm-3">
                <input name="lastName" maxlength="70" placeholder="Card Holder Last Name" class="card-holder-last-name form-control"
                       value="{{ formValues.lastName }}">
            </div>
            <div class="clearfix"></div>
            <div class="col-sm-offset-2 col-sm-3">
                <span class="help-block">{% if paymentForm is defined %}{{ paymentForm.getError('firstName') }}{% endif %}</span>
            </div>
            <div class="col-sm-3">
                <span class="help-block">{% if paymentForm is defined %}{{ paymentForm.getError('lastName') }}{% endif %}</span>
            </div>
        </div>

        <!-- Card Number -->
        <div class="form-group {% if paymentForm is defined and paymentForm.hasErrors('number') %}has-error{% endif %}">
            <label class="col-sm-2 control-label">Card Number</label>
            <div class="col-sm-6">
                <input name="number" maxlength="19" placeholder="Card Number" class="card-number form-control" value="{{ formValues.number }}">
            </div>
            <div class="clearfix"></div>
            <div class="col-sm-offset-2 col-sm-6">
                <span class="help-block">{% if paymentForm is defined %}{{ paymentForm.getError('number') }}{% endif %}</span>
            </div>
        </div>

        <!-- Expiry-->
        <div class="form-group {% if paymentForm is defined and (paymentForm.hasErrors('month') or paymentForm.hasErrors('year')) %}has-error{% endif %}">
            <label class="col-sm-2 control-label">Card Expiry Date</label>
            <div class="col-sm-6">
                <div class="form-inline">
                    <select class="form-control" name="month">
                        {% for month in 1..12  %}
                            <option value="{{ month }}" {% if formValues.month == month %}selected{% endif %}>{{ month }}</option>
                        {% endfor %}
                    </select>
                    <span> / </span>
                    <select class="required form-control" name="year">
                        {% for year in currentYear..(currentYear + 12)  %}
                            <option value="{{ year }}" {% if formValues.year == year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="clearfix"></div>
            <div class="col-sm-offset-2 col-sm-6">
                <span class="help-block">{% if paymentForm is defined %}{{ paymentForm.getError('month') }}{% endif %}</span>
                <span class="help-block">{% if paymentForm is defined %}{{ paymentForm.getError('year') }}{% endif %}</span>
            </div>
        </div>

        <!-- CVV -->
        <div class="form-group {% if paymentForm is defined and paymentForm.hasErrors('cvv') %}has-error{% endif %}">
            <label class="col-sm-2 control-label">CVV/CVV2</label>
            <div class="col-sm-1">
                <input name="cvv" placeholder="CVV" maxlength="4" class="card-cvc form-control" value="{{ formValues.cvv }}">
            </div>
            <div class="clearfix"></div>
            <div class="col-sm-offset-2 col-sm-6">
                <span class="help-block">{% if paymentForm is defined %}{{ paymentForm.getError('cvv') }}{% endif %}</span>
            </div>
        </div>
        {% endif %}

        <!-- Amount -->
        <div class="form-group">
            <label class="col-sm-2 control-label" for="amount">Amount</label>
            <div class="col-sm-1">
                <input class="form-control" disabled value="{{ cart.finalPrice|number_format(2) }}"/>
            </div>
        </div>

        <!-- Submit -->
        <div class="form-group">
            <div class="control-group">
                <div class="controls">
                    <center>
                        <button class="btn btn-success" type="submit">Pay Now</button>
                    </center>
                </div>
            </div>
        </div>
    </fieldset>
</form>
{% endif %}
