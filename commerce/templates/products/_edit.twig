{% extends "commerce/_layouts/cp" %}

{% set selectedSubnavItem = "products" %}

{% set crumbs = [
{ label: "Products"|t, url: url('commerce/products') }
] %}

{% import "_includes/forms" as forms %}


{% macro generalVariantFields(variant) %}
	{% import "_includes/forms" as forms %}

	{{ forms.textField({
		id: 'sku',
		label: 'SKU'|t,
		required: true,
		name: 'sku',
		value: variant.sku,
		placeholder: 'Enter SKU'|t,
		errors: variant.getErrors('sku')
	}) }}

	{{ forms.textField({
		id: 'price',
		label: 'Price',
		name: 'price',
		value: (variant.price ? variant.price|commerceDecimal ?: ''),
		placeholder: 'Enter price'|t,
		unit: craft.commerce.settings.defaultCurrency,
		required: true,
		errors: variant.getErrors('price')
	}) }}

	{% set stockInput %}
		<div class="flex">
			{{ forms.text({
				id: 'stock',
				name: 'stock',
				value: (variant.stock ?: ''),
				placeholder: 'Enter stock'|t,
				disabled: variant.unlimitedStock
			}) }}
			{{ forms.checkbox({
				id: 'unlimited-stock',
				class: 'unlimited-stock',
				label: 'Unlimited'|t,
				name: 'unlimitedStock',
				checked: variant.unlimitedStock,
			}) }}
		</div>
	{% endset %}

	{{ forms.field({
		id: 'stock',
		label: 'Stock',
		errors: variant.getErrors('unlimitedStock')|merge(variant.getErrors('stock')),
	}, stockInput) }}

	{% set quantityRangeInput %}
		<div class="flex">
			{{ forms.text({
				id: 'minQty',
				name: 'minQty',
				value: variant.minQty,
				placeholder: 'Any'|t,
				title: 'Minimum allowed quantity'|t
			}) }}
			<span class="label light">{{ 'to'|t }}</span>
			{{ forms.text({
				id: 'maxQty',
				name: 'maxQty',
				value: variant.maxQty,
				placeholder: 'Any'|t,
				title: 'Maximum allowed quantity'|t
			}) }}
		</div>
	{% endset %}

	{{ forms.field({
		id: 'minQty',
		label: 'Allowed Qty'|t,
		errors: variant.getErrors('minQty')|merge(variant.getErrors('maxQty'))
	}, quantityRangeInput) }}
{% endmacro %}

{% macro dimensionVariantFields(variant) %}
	{% import "_includes/forms" as forms %}

	{% set dimensionsInput %}
		<div class="flex">
			{{ forms.text({
				id: 'width',
				name: 'width',
				value: (variant.width|commerceDecimal ?: ''),
				placeholder: 'Width'|t|upper[0:1],
				title: 'Width'|t,
				unit: craft.commerce.settings.dimensionUnits,
				errors: variant.getErrors('width')
			}) }}
			<span class="label light">/</span>
			{{ forms.text({
				id: 'height',
				name: 'height',
				value: (variant.height|commerceDecimal ?: ''),
				placeholder: 'Height'|t|upper[0:1],
				title: 'Height'|t,
				unit: craft.commerce.settings.dimensionUnits,
				errors: variant.getErrors('height')
			}) }}
			<span class="label light">/</span>
			{{ forms.text({
				id: 'length',
				name: 'length',
				value: (variant.length|commerceDecimal ?: ''),
				placeholder: 'Depth'|t|upper[0:1],
				title: 'Depth'|t,
				unit: craft.commerce.settings.dimensionUnits,
				errors: variant.getErrors('length')
			}) }}
			<span class="label light">{{ craft.commerce.settings.dimensionUnits }}</span>
		</div>
	{% endset %}

	{{ forms.field({
		label: 'Dimensions'|t,
		id: 'width'
	}, dimensionsInput) }}

	{{ forms.textField({
		id: 'weight',
		label: 'Weight'|t,
		name: 'weight',
		value: (variant.weight|commerceDecimal ?: ''),
		placeholder: 'Enter weight'|t,
		unit: craft.commerce.settings.weightUnits,
		errors: variant.getErrors('weight')
	}) }}
{% endmacro %}

{% from _self import generalVariantFields, dimensionVariantFields %}


{% block main %}
	<form id="product-form" method="post" accept-charset="UTF-8"
		  data-saveshortcut
		  data-saveshortcut-redirect="{{ continueEditingUrl }}"
		  data-confirm-unload>

		<input type="hidden" name="action" value="commerce/products/saveProduct">
		<input type="hidden" name="redirect" value="commerce/products">
		<input type="hidden" name="typeId" value="{{ productType.id }}">
		{% if craft.isLocalized() %}<input type="hidden" name="locale" value="{{ product.locale }}">{% endif %}
		{{ getCsrfInput() }}
		{% if product.id %}<input type="hidden" name="productId" value="{{ product.id }}">{% endif %}


		<div class="grid first" data-max-cols="3">
			<div class="item" data-position="left" data-min-colspan="2"
				 data-max-colspan="3">

				<div id="fields" class="pane">
					{% include "_includes/tabs" %}

					{% from "_includes/forms" import textField %}
					{% set static = static is defined ? static : false %}

					{{ textField({
						label: "Name"|t,
						locale: product.locale,
						id: 'title',
						name: 'title',
						value: product.title,
						errors: (not static ? product.getErrors('title')),
						first: true,
						autofocus: true,
						required: (not static),
						disabled: static,
						maxlength: 255
					}) }}

					{% set allProductTab = productType.asa('productFieldLayout').getFieldLayout().getTabs() %}
					{% for tab in allProductTab %}
						<div id="tab{{ loop.index }}" {% if not loop.first %} class="hidden" {% endif %}>
							{% include "_includes/fields" with {
							fields: tab.getFields(),
							element: product,
							static: (static is defined ? static : false)
							} only %}
						</div>
					{% endfor %}
				</div>

				{% if productType.hasVariants %}
					<div class="pane">
						{% include "_includes/tabs" with {
							tabs: {
								variantsTab: { label: 'Variants'|t, url: '#variantsTab' }
							}
						} %}

						{{ variantMatrixHtml|raw }}
					</div>
				{% endif %}
			</div>

			<div class="item" data-position="right" data-colspan="1">

				{% if craft.isLocalized() %}
					<ul id="locales" class="pane">
						{% for localeId in localeIds %}
							{% set localeName = craft.i18n.getLocaleById(localeId).name %}
							<li{% if localeId == product.locale %} class="sel"{% endif %}>
								{%- if localeId == product.locale -%}
									{{ localeName }}
									{{ forms.lightswitch({
										name: 'localeEnabled',
										on:   product.localeEnabled,
										small: true
									}) }}
								{%- else -%}
									{% set localeUrl = url(
									'commerce/products/'~productType.handle~'/'~craft.request.getSegment(4)~'/'~localeId
									) -%}
									<a href="{{ localeUrl }}">{{ localeName }}</a>
									<div class="status {{ localeId in enabledLocales ? 'enabled' : 'disabled' }}"></div>
								{%- endif -%}
							</li>
						{% endfor %}
					</ul>
				{% endif %}


				<div class="pane meta">
					{{ forms.textField({
						label: "Slug"|t,
						locale: product.locale,
						id: 'slug',
						name: 'slug',
						value: product.slug,
						placeholder: 'Enter slug'|t,
						errors: product.getErrors('slug')|merge(product.getErrors('uri'))
					}) }}

					{{ forms.dateTimeField({
						label: 'Post Date'|t,
						id: 'availableOn',
						name: 'availableOn',
						value: product.availableOn,
						errors: product.getErrors('availableOn')
					}) }}

					{{ forms.dateTimeField({
						label: 'Expiry Date'|t,
						id: 'expiresOn',
						name: 'expiresOn',
						value: product.expiresOn,
						errors: product.getErrors('expiresOn')
					}) }}

					{% set enabledswitch %}
						<div class="left">
							{{ forms.lightswitch({
								id: 'enabled',
								name: 'enabled',
								label: 'Enabled?',
								on: product.enabled,
								disabled: false
							}) }}
						</div>
						<div class="right">
							{% if productId is defined %}
								<input type="button"
									   class="btn small formsubmit"
									   value="{{ 'Delete'|t }}"
									   data-action="commerce/products/deleteProduct"
									   data-confirm="{{ 'Are you sure you want to delete this product?'|t }}"
									   data-redirect="commerce/products">
							{% endif %}
						</div>
					{% endset %}

					{{ forms.field({
						id:       'status',
						label:    'Enabled'
					},enabledswitch) }}

				</div>{#END PANE#}

				<div class="pane meta">
					{{ forms.selectField({
						label: 'Tax Category'|t,
						name: 'taxCategoryId',
						value: product.taxCategoryId,
						required: true,
						options: taxCategories
					}) }}

					{{ forms.checkboxField({
						fieldLabel: 'Free Shipping'|t,
						name: 'freeShipping',
						checked: (product.id ? product.freeShipping : 0),
					}) }}

					{{ forms.checkboxField({
						fieldLabel: 'Promotable'|t,
						name: 'promotable',
						checked: (product.id ? product.promotable : 1),
					}) }}
				</div>

				{% if not productType.hasVariants %}
					{% namespace 'variants['~(primaryVariant.id ?: 'new1')~']' %}
						<div class="pane meta">
							{{ generalVariantFields(primaryVariant) }}
						</div>
						<div class="pane meta">
							{{ dimensionVariantFields(primaryVariant) }}
						</div>
					{% endnamespace %}
				{% endif %}

				<table class="inputs fullwidth">
					<tr>
						<td class="thin">
							<div class="btngroup submit first">
								<input type="submit" class="btn submit"
									   value="{{ 'Save'|t }}">

								<div class="btn submit menubtn"></div>
								<div class="menu">
									<ul>
										<li><a class="formsubmit"
											   data-redirect="{{ continueEditingUrl }}">
												{{ "Save and continue editing"|t }}
												{{ forms.optionShortcutLabel('S') }}
											</a></li>

										{% if productType.hasVariants %}
											<li><a class="formsubmit"
												   data-param="entryId"
												   data-value=""
												   data-redirect="commerce/products/{type.handle}/{id}/variants/new"
												   data-value="1">{{ 'Save and add new variant'|t }}</a>
											</li>
										{% endif %}

									</ul>
								</div>
							</div>
						</td>
						<td>

						</td>
					</tr>
				</table>

			</div>

		</div>


	</form>


	{% if not product.slug %}
		{% includejs %}
			window.slugGenerator = new Craft.SlugGenerator('#title', '#slug');
		{% endincludejs %}
	{% endif %}

{% endblock %}


{% includejs %}
	$('input.unlimited-stock').change(function() {
		var $checkbox = $(this),
			$text = $checkbox.prevAll('.text:first');

		if ($checkbox.prop('checked'))
		{
			$text.prop('disabled', true).addClass('disabled').val('');
		}
		else
		{
			$text.prop('disabled', false).removeClass('disabled').focus();
		}
	});
{% endincludejs %}
