{% extends "commerce/_layouts/settingscp" %}

{% set crumbs = [
{ label: "Commerce Settings"|t, url: url('commerce/settings') },
{ label: "Currencies"|t, url: url('commerce/settings/paymentcurrencies') },
] %}

{% set fullPageForm = true %}

{% import "_includes/forms" as forms %}

{% block content %}
    <input type="hidden" name="action" value="commerce/paymentCurrencies/save">
    <input type="hidden" name="redirect" value="commerce/settings/paymentcurrencies">
    {% if currency.id %}<input type="hidden" name="currencyId" value="{{ currency.id }}">{% endif %}

    {{ forms.textField({
        first: true,
        label: "Name"|t,
        instructions: "What this currency will be called in the CP."|t,
        id: 'name',
        name: 'name',
        value: currency.name,
        errors: currency.getErrors('name'),
        autofocus: true,
        required: true,
        translatable: true
    }) }}

	{{ forms.selectField({
		label: 'Currency Code'|t,
		instructions: 'Choose the currency’s ISO code.'|t,
		id: 'iso',
		name: 'iso',
		value: currency.iso,
		errors: currency.getErrors('iso'),
		class: 'selectize fullwidth',
	}) }}

    {{ forms.textField({
        label: "Conversion Rate"|t,
        instructions: "The conversion rate that will be used when converting an amount to this currency. For example, if an item costs {amount1}, a conversion rate of {rate} would result in {amount2} in the alternate currency."|t({
			amount1: 10|currency(craft.commerce.getDefaultCurrency().iso),
			rate: 1.5,
			amount2: 15
		}),
        id: 'rate',
        name: 'rate',
        disabled: currency.default,
        value: currency.rate ?: 1,
        errors: currency.getErrors('rate')
    }) }}

    {% if currency.default %}
        <input type="hidden" name="default" value="1"/>
    {% endif %}

    {% if currency.default %}
        <p class="warning">This is the current store’s currency. This is the currency all values in the database are stored in. <br>If you change this currency, all previous orders will show as being in the currency. Get this currency correct before starting your store.</p>
    {% endif %}
{% endblock %}

{% includejs %}
window.currencies = $.map(JSON.parse('{{ craft.commerce.currencies|json_encode|raw }}'), function(el) { return el });
window.currency = JSON.parse('{{ [currency.iso]|json_encode|raw }}');
$(function () {
    $('#iso').selectize({
		options: window.currencies,
		items : window.currency,
		render: {
			item: function(item, escape) {
			return '<div>' +
				(item.currency ? '<span class="currency">' + escape(item.currency) + '</span>' : '') +
				(item.alphabeticCode ? ' (<span class="alphabeticCode">' + escape(item.alphabeticCode) + '</span>)' : '') +
				'</div>';
			},
			option: function(item, escape) {
			var label = item.currency || item.alphabeticCode;
			var caption = item.currency ? item.alphabeticCode : null;
			return '<div>' +
				'<span class="label">' + escape(label) + '</span>' +
				(caption ? ' (<span class="caption">' + escape(caption) + '</span>)' : '') +
				'</div>';
			}
		},
		valueField: 'alphabeticCode',
		labelField: 'currency',
		sortField: 'currency',
		searchField: ['currency', 'iso'],
        dropdownParent: 'body',
		maxItems: 1
    });
});
{% endincludejs %}
